
INSTALL=@INSTALL@
LIBDIR=@libdir@
CXX = @CXX@

OBJECTS:=dbBase.o \
		tools.o \
		xexec.o \
		dbSqlBase.o \
		baseEx.o \
		dbMysql.o \
		cgiTools.o \
		regexpTools.o \
		flushSocketOptions.o \
		flushSocketExchange.o \
		flushSocketTools.o \
		flushSocket.o \
		flushDiskTools.o \
		flushDisk.o \
		flushSTD.o \
		systemTools.o \
		timeTools.o \
		xmlTools.o \
		dbSqlite.o \
		systemThreads.o \
		systemThreadShares.o \
		dbPostgresql.o \
		cgiPreprocessor.o \
		flush.o \
		dbInterface.o \
		cgiFast.o \
		cgiProcessor.o \
		flushNBA.o

###########################################################

CPPFLAGS:=-I./include @CPPFLAGS@
LDFLAGS:= -L./ @LDFLAGS@
LIBS:=@LIBS@

DEFINES:=-D_REENTRANT -D_GNU_SOURCE -D__USE_UNIX98 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64

VPATH:=src

LIBRARY:=libdodo

MAJOR:=0
MINOR:=3
RELEASE:=0

all: $(LIBRARY)

$(LIBRARY): $(OBJECTS)
	$(CXX) $(CFLAGS) $(LDFLAGS) $(LIBS) -shared -Wl,-soname,$@.so.$(MAJOR).$(MINOR).$(RELEASE) -o $@.so.$(MAJOR).$(MINOR).$(RELEASE) $(OBJECTS)
	strip -d --strip-unneeded $(LIBRARY).so.$(MAJOR).$(MINOR).$(RELEASE)
	ln -sf $(LIBRARY).so.$(MAJOR).$(MINOR).$(RELEASE) $@.so
	
	ar rc $(LIBRARY).a.$(MAJOR).$(MINOR).$(RELEASE) $(OBJECTS)
	ln -sf $(LIBRARY).a.$(MAJOR).$(MINOR).$(RELEASE) $@.a
	
	@echo ""
	@echo ""
	@echo "Now you can run 'gmake install'. [PREFIX=$(PREFIX)] - change it in directives.mk if you want"

.cc.o:
	$(CXX) $(DEFINES) $(CPPFLAGS) $(CFLAGS) $(DEBUG) -fPIC -c $^
	strip -d --strip-unneeded $@

install: all
	${INSTALL} -d -m 644 $(LIBRARY).so.$(MAJOR).$(MINOR).$(RELEASE) $(LIBDIR)
	${INSTALL} -d -m 644  include/* $(INCLUDEDIR)/
	
	$(LN_S) $(LIBDIR)/$(LIBRARY).so.$(MAJOR).$(MINOR).$(RELEASE) $(LIBDIR)/$(LIBRARY).so
	
	@echo ""
	@echo ""
	@echo "Use libdodo with pleasure"
	@echo ""
	@echo ""
	
clean:
	rm -rf *.o *.so* *.a*

force : clean $(LIBRARY)
